<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                template="/WEB-INF/template.xhtml">
    <h:head>
        <title>PRISM Project Cost</title>
    </h:head>
    <ui:define name="content">
        <p:growl id="addErrorMsg" showDetail="true" />
        <p:panelGrid columns="2" layout="grid">

            <h:form id="projectCostForm">
                <p:fieldset legend="#{viewProjectCostBean.module.course.moduleCode} Group #{viewProjectCostBean.group.name} - Transactions" toggleable="false" collapsed="false">
                    <h:outputText id="emptyLabel" value="Your group yet to add any transactions!" rendered="#{empty viewProjectCostBean.sortedTransactions}"/>
                    <p:panelGrid columns="2" layout="grid" rendered="#{not empty viewProjectCostBean.sortedTransactions}">
                        <p:dataTable selectionMode="single" selection="#{viewProjectCostBean.selectedTransaction}" rowKey="#{transaction.id}"
                                     id="transactiontable" rendered="#{not empty viewProjectCostBean.sortedTransactions}"
                                     editable="true" editMode="cell" 
                                     emptyMessage="No transactions found."                                          
                                     paginator="true" paginatorAlwaysVisible="false" paginatorPosition="bottom"
                                     rows="10" 
                                     paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                     rowsPerPageTemplate="10,20,30" 
                                     value="#{viewProjectCostBean.sortedTransactions}" var="transaction"
                                     scrollable="true" scrollWidth="auto"
                                     tableStyle="white-space: nowrap;">
                            <p:ajax event="rowSelect" listener="#{viewProjectCostBean.onRowSelect}" update="addErrorMsg, projectCostForm:transactionInfoBox" />
                            <f:facet name="header">
                                Activity
                            </f:facet>
                            <p:column>
                                <h:outputLabel value="#{transaction.activity}" />
                                <h:outputLabel value=" - #{transaction.date}" >
                                    <f:convertDateTime pattern="dd-MM-yyyy" />
                                </h:outputLabel>
                            </p:column>
                        </p:dataTable>
                        <h:panelGroup id="transactionInfoBox">
                            <h4><h:outputText value="#{viewProjectCostBean.selectedTransaction.date}">
                                    <f:convertDateTime pattern="dd-MM-yyyy" />
                                </h:outputText>
                            </h4>
                            <ui:repeat var="l" value="#{viewProjectCostBean.selectedTransaction.ledgers}">
                                <h:outputText value="#{l.student.name}" />
                                <h:outputText value=" paid " rendered="#{l.pay != 0.0}"/>
                                <h:outputText value="#{l.pay}" rendered="#{l.pay != 0.0}">
                                    <f:convertNumber pattern="#0.00" />
                                </h:outputText>
                                <h:outputText value=" dollars " rendered="#{l.pay != 0.0}"/>
                                <h:outputText value="  and  " rendered="#{l.pay != 0.0 and l.ascCost != 0.0}"/>
                                <h:outputText value=" owes " rendered="#{l.ascCost != 0.0}"/>
                                <h:outputText value="#{l.ascCost}" rendered="#{l.ascCost != 0.0}">
                                    <f:convertNumber pattern="#0.00" />
                                </h:outputText>
                                <h:outputText value=" dollars " rendered="#{l.ascCost != 0.0}"/>
                                <h:outputText value=" does not need to pay anything" rendered="#{l.ascCost == 0.0}"/>
                                <br/>
                            </ui:repeat>
                            <p:commandButton rendered="#{viewProjectCostBean.selectedTransaction != null}" id="deleteButton" icon="ui-icon-trash" actionListener="#{viewProjectCostBean.deleteTransaction()}" update="projectCostForm, addErrorMsg, summaryForm"/>
                        </h:panelGroup>

                    </p:panelGrid>
                </p:fieldset>
            </h:form>
            <h:panelGrid columns="1">
                <h:form id="summaryForm">
                    <p:fieldset collapsed="false" styleClass="menuHeader" id="balance" legend="Summary" toggleable="false" toggleSpeed="500" >
                        <h:outputText id="emptyLabel" value="No member in your group owes anyone anything! Hooray!" rendered="#{empty viewProjectCostBean.sortedTransactions}"/>
                        <p:dataList value="#{viewProjectCostBean.balances}" var="balance" rendered="#{not empty viewProjectCostBean.sortedTransactions}">
                            <h4>
                                <h:outputText value="#{balance.student.name}"/>
                            </h4>
                            <p:separator />
                            <h:outputText value="#{balance.student.name}: "/>
                            <h:outputText value="has zero balance" rendered="#{balance.totalAmount eq 0}"/>
                            <h:outputText value="owes $" rendered="#{balance.totalAmount lt 0}"/>
                            <h:outputText value="gets back $" rendered="#{balance.totalAmount gt 0}"/>
                            <h:outputText value="#{(balance.totalAmount lt 0) ? -balance.totalAmount : balance.totalAmount}" rendered="#{balance.totalAmount ne 0}">
                                <f:convertNumber pattern="#0.00" />
                            </h:outputText>
                            <h:outputText value=" in total" rendered="#{balance.totalAmount ne 0}"/>
                            <br />
                            <ui:repeat value="#{balance.getBalances()}" var="payee">
                                <h:outputText value="#{balance.student.name} should receive $" rendered="#{balance.totalAmount gt 0}"/>
                                <h:outputText value="#{payee.value}" rendered="#{balance.totalAmount gt 0}">
                                    <f:convertNumber pattern="#0.00" />
                                </h:outputText>
                                <h:outputText value=" from #{payee.key.name}" rendered="#{balance.totalAmount gt 0}"/>
                                <h:outputText value="#{balance.student.name} owes $" rendered="#{balance.totalAmount lt 0}"/>
                                <h:outputText value="#{payee.value}" rendered="#{balance.totalAmount lt 0}">
                                    <f:convertNumber pattern="#0.00" />
                                </h:outputText>
                                <h:outputText value=" to #{payee.key.name}" rendered="#{balance.totalAmount lt 0}"/>
                                <br />
                            </ui:repeat>
                            <br/>
                        </p:dataList>
                    </p:fieldset>
                </h:form>

                <p:fieldset collapsed="false" styleClass="menuHeader" id="addtransaction" legend="Add new transaction" toggleable="false" toggleSpeed="500">
                    <h:form id="addTransactionForm">
                        <h:panelGrid columns="2">
                            <h:panelGrid columns="2" id="addBasicInfo">
                                <h:outputLabel for="activity" value="Activity: " /> 
                                <p:inputText id="activity" value="#{viewProjectCostBean.activity}" required="true"/>
                                <h:outputLabel for="totalCost" value="Total Cost: " /> 
                                <p:inputNumber id="totalCost" value="#{viewProjectCostBean.totalCost}" symbol="$" symbolPosition="p" minValue="0.00" />
                                <p:outputLabel for="addDate" value="Date:"/>
                                <p:calendar id="addDate" value="#{viewProjectCostBean.date}" placeholder="Today"/>
                            </h:panelGrid>
                            <h:panelGrid columns="2" id="indPayer">
                                <h:outputLabel for="paidBy" value="Paid by: " /> 
                                <p:selectOneMenu id="paidBy" value="#{viewProjectCostBean.paidBy}" >
                                    <p:ajax event="change" update="addTransactionForm:indPayer, addTransactionForm:multiplePayers" />
                                    <f:selectItem itemLabel="Individual" itemValue="Individual"/>
                                    <f:selectItem itemLabel="Multiple People" itemValue="Multiple People"/>
                                </p:selectOneMenu>
                                <h:outputText id="individualPayerLabel" value="Payer: " rendered="#{viewProjectCostBean.paidBy == 'Individual'}"/>
                                <p:selectOneMenu id="individualPayer" value="#{viewProjectCostBean.individualPayerId}" rendered="#{viewProjectCostBean.paidBy == 'Individual'}" >
                                    <f:selectItems value="#{viewProjectCostBean.groupMembers}" var="student" itemLabel="#{student.name}" itemValue="#{student.id}"/> 
                                </p:selectOneMenu>
                            </h:panelGrid>
                            <h:panelGrid id="multiplePayers" >
                                <h:outputText value="Enter the amount each member has paid" rendered="#{viewProjectCostBean.paidBy == 'Multiple People'}"/>
                                <br />
                                <ui:repeat value="#{viewProjectCostBean.all}" var="payer" rendered="#{viewProjectCostBean.paidBy == 'Multiple People'}"> 
                                    <h:outputText value="#{payer.student.name}"/>
                                    <p:inputNumber value="#{payer.pay}" minValue="0.00" symbol="$" symbolPosition="p" >
                                        <p:ajax event="keyup" update="addTransactionForm:totalCost" listener="#{viewProjectCostBean.totalCostAdd}"/>
                                    </p:inputNumber>
                                    <br />
                                </ui:repeat>
                            </h:panelGrid>
                        </h:panelGrid>
                        <br />
                        <h:panelGrid columns="2">
                            <h:outputLabel for="splitBy" value="Split by: " /> 
                            <p:selectOneMenu id="splitBy" value="#{viewProjectCostBean.splitBy}" >
                                <p:ajax event="change" update="addTransactionForm:splitAmount, addTransactionForm:splitpercentage,"  />
                                <f:selectItem itemLabel="Equally" itemValue="Equally"/>
                                <f:selectItem itemLabel="Exact Amount" itemValue="Exact Amount"/>
                                <f:selectItem itemLabel="Percentage" itemValue="Percentage"/>
                            </p:selectOneMenu>
                        </h:panelGrid>
                        <h:panelGrid columns="2" id="splitAmount">
                            <h:outputText value="Enter the eact amount each member must pay" rendered="#{viewProjectCostBean.splitBy == 'Exact Amount'}"/>
                            <br />
                            <ui:repeat value="#{viewProjectCostBean.all}" var="payee" rendered="#{viewProjectCostBean.splitBy == 'Exact Amount'}"> 
                                <h:outputLabel  for="inputCost" value="#{payee.student.name}: "/>
                                <p:inputNumber id="inputCost" value="#{payee.cost}" symbol="$" symbolPosition="p" minValue="0.00"/>
                                <br />
                            </ui:repeat>
                        </h:panelGrid>
                        <h:panelGrid columns="2" id="splitpercentage">
                            <h:outputText value="Enter the percentage each member must pay" rendered="#{viewProjectCostBean.splitBy == 'Percentage'}"/>
                            <br />
                            <ui:repeat value="#{viewProjectCostBean.all}" var="payee" rendered="#{viewProjectCostBean.splitBy == 'Percentage'}"> 
                                <h:outputText value="#{payee.student.name}"/>
                                <p:inputNumber value="#{payee.cost}" symbol="%" symbolPosition="s" emptyValue="zero" minValue="0.00"/>
                                <br />
                            </ui:repeat>
                        </h:panelGrid>
                        <p:commandButton id ="addtransactionButton" value="Add Transaction" action="#{viewProjectCostBean.addTransaction()}" update="projectCostForm, addErrorMsg, summaryForm, addTransactionForm"/> 
                    </h:form>
                </p:fieldset>
            </h:panelGrid>
        </p:panelGrid>
        <h:form id="initializePageDataForm">
            <p:remoteCommand name="initializePageDataCommand" autoRun="true" action="#{viewProjectCostBean.init()}" update="projectCostForm"/>
        </h:form>
    </ui:define>
</ui:composition>


<ui:composition 
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:p="http://primefaces.org/ui"
    xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">

    <div id="right-sidebar" class="right-sidebar">
        <div class="nano">
            <div class="right-sidebar-header ui-widget-header">
                <i class="fa fa-star"></i>
                <span>Messenger</span>
                <a id="right-sidebar-button-close" href="#">
                    <i class="fa fa-angle-right"></i>
                </a>
            </div>

            <div class="nano-content sidebar-scroll-content">
                <p:tabView id="msgTabView" activeIndex="#{privateMsgBean.tabIndex}">
                    <p:tab title="Contacts">
                        <div style="overflow: hidden; overflow-wrap:break-word; height:90vh;">
                            <div style=" height: 75vh; overflow-y: scroll; width: 240px">
                                <div class="search-input">
                                    <h:form id="form1">
                                        <!--<p:inputText value=""
                                                     placeholder="Search for user..." styleClass="inputMsg"
                                                     onkeypress="if (event.keyCode == 13) {
                                                                 searchUser();
                                                                 return false;
                                                             }" />
                                        <i class="fa fa-search"></i>-->
                                        
                                        <p:selectOneMenu id="userList" value="#{privateMsgBean.searchUsername}"  panelStyle="width:190px" effect="fade" 
                                                             var="user" style="width:190px" filter="true" filterMatchMode="contains" appendTo="@this">
                                                <p:ajax event="change" listener="#{privateMsgBean.startConversation}" update="msgTabView:form1"/>
                                                <f:selectItem itemLabel="Search a contact" itemValue="select"/>
                                                <f:selectItems value="#{privateMsgBean.getUsers()}" var="users" itemLabel="#{users.name}" itemValue="#{users.username}" />
                                            </p:selectOneMenu>

                                        

                                        <p:dataList rendered="#{not empty privateMsgBean.convoList}" id="myContacts" var="convo" value="#{privateMsgBean.convoList}">
                                            <button type="button" onclick="#{privateMsgBean.getRcvrUsername(convo)}convo()" class="convoBox">
                                                <p:remoteCommand name="#{privateMsgBean.getRcvrUsername(convo)}convo" update="msgTabView"
                                                                 action="#{privateMsgBean.selectConversation(convo)}"/>

                                                <h:outputText value="#{privateMsgBean.rcvName}"/>
                                                <br/>

                                                <h:outputText rendered="#{empty convo.messages}" style="color: #777777" value=" "/>
                                                <h:outputText rendered="#{not empty convo.messages}" style="color: #777777" value="#{convo.messages.get(convo.messages.size()-1).getMessage()}"/>

                                                <i class="fa fa-angle-right" style="float:right; color: #777777; font-size: 1.5em"/>
                                            </button>
                                            <hr style="border: none; height: 1px; background-color: #dddddd"/>
                                        </p:dataList>

                                    </h:form>
                                </div>
                            </div>
                        </div>
                    </p:tab>

                    <p:tab title="Chat">
                        <div style="overflow: hidden; overflow-wrap:break-word; height:90vh;">
                            <h:form id="form2">
                                <c:if test="#{not empty privateMsgBean.convo}">
                                    <h:outputText style="margin-top:5px;float:left;" value="#{privateMsgBean.getRcvName(privateMsgBean.convo)}"/>

                                    <p:commandButton icon="fa fa-minus" styleClass="delConvoBtn" update="msgTabView" actionListener="#{privateMsgBean.deleteConversation}">
                                        <p:confirm header="Delete Conversation" message="Are you sure you want to delete this conversation?" icon="ui-icon-alert" />
                                    </p:commandButton>

                                    <br/><br/><hr style="margin-bottom: 1px; border: none; height: 1px; background-color: #dddddd"/>
                                </c:if>

                                <div style=" height: 60vh; overflow-y: scroll; width: 240px;">
                                    <c:if test="#{empty privateMsgBean.convo}">
                                        <h:outputText value="Please select a contact first!" />
                                    </c:if>

                                    <c:if test="#{not empty privateMsgBean.msgList}">
                                        
                                        <p:dataList id="myMessages" var="msg" value="#{privateMsgBean.msgList}">
                                            <h:outputText rendered="#{privateMsgBean.messageIsByUser(msg)}" value="#{msg.getMessage()}" class="chatBubble_left"/>
                                            <br/>
                                            <h:outputText rendered="#{not privateMsgBean.messageIsByUser(msg)}" value="#{msg.getMessage()}" class="chatBubble_right"/>
                                            <br/>
                                        </p:dataList>
                                    </c:if>


                                    <c:if test="#{privateMsgBean.convoExist}">
                                        <div class="ui-fluid contact-form" style="bottom: 15vh; position: absolute">

                                            <h:panelGrid rendered="#{not privateMsgBean.checkEmptyUser()}" columns="2" styleClass="columnItems">
                                                <p:inputTextarea value="#{privateMsgBean.content}" placeholder="type your message..." rows="1" cols="30" maxlength="300" styleClass="inputMsg"
                                                                 onkeypress="if (event.keyCode == 13) {
                                                                             submitMsg();
                                                                             return false;
                                                                         }"/>
                                                <p:commandButton type="submit" icon="fa fa-paper-plane-o" update="msgTabView" styleClass="sendMsg" action="#{privateMsgBean.sendMessage}"></p:commandButton>
                                                <p:remoteCommand name="submitMsg" update="msgTabView" actionListener="#{privateMsgBean.sendMessage}"/>
                                            </h:panelGrid>
                                            <h:outputText rendered="#{privateMsgBean.checkEmptyUser()}" value="User has left the conversation."/>
                                        </div>
                                    </c:if>
                                </div>
                            </h:form>
                        </div>
                    </p:tab>
                </p:tabView>

                <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
                    <p:commandButton value="Yes" type="button" styleClass="ui-confirmdialog-yes" icon="ui-icon-check" />
                    <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no" icon="ui-icon-close" />
                </p:confirmDialog>
            </div>
        </div>
    </div>

    <style type="text/css">
        .ui-datalist-content{
            border: none !important;
        }
        .convoBox{
            background: #ffffff;
            width:100%;
            height: 50px;
            text-align: left;
            border: none;
            margin: -7px 0px -7px 0px;
        }    
        .convoBox:hover {
            background: #efefef;
            text-decoration: none;
        }
        .delConvoBtn{
            background-color: transparent !important;
            color: #ffa0a0 !important;
            float: right;
        }
        .chatBubble_left{
            -webkit-border-radius: 20;
            -moz-border-radius: 20;
            border-radius: 20px;
            color: #000000;
            background: #e6e6e6;
            padding: 5px 10px 5px 10px;
            text-decoration: none;
            float: left;
            max-width: 150px;
            word-wrap: break-word;
        }
        .chatBubble_right{
            -webkit-border-radius: 20;
            -moz-border-radius: 20;
            border-radius: 20px;
            color: #ffffff;
            background: #32ebc6;
            padding: 5px 10px 5px 10px;
            margin-right: 5px; 
            text-decoration: none;
            float: right;
            max-width: 150px;
            word-wrap: break-word;
        }
        .columnItems {
            margin: 0px -10px 0px -10px !important; 
        }
        .columnItems td {
            vertical-align: bottom;
        }
        .inputMsg{
            -webkit-border-radius: 20 !important;
            -moz-border-radius: 20 !important;
            border-radius: 20px !important;
        }
        .sendMsg{
            -webkit-border-radius: 20 !important;
            -moz-border-radius: 20 !important;
            border-radius: 20px !important;
            width: 30px !important;
            margin: 0px !important;
        }
    </style>

    <script>
        function scrollToBottom() {
            $('.ui-datalist-scrollable-body').scrollTop(100000)
        }
    </script>

</ui:composition>